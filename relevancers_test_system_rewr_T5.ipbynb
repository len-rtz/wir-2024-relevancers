{
  "nbformat": 4,
  "nbformat_minor": 0,
  "metadata": {
    "colab": {
      "provenance": [],
      "gpuType": "T4",
      "authorship_tag": "ABX9TyM/H4yerqkh0zzTfDKRvU19",
      "include_colab_link": true
    },
    "kernelspec": {
      "name": "python3",
      "display_name": "Python 3"
    },
    "language_info": {
      "name": "python"
    },
    "widgets": {
      "application/vnd.jupyter.widget-state+json": {
        "39f425f303a64b2cadcc53ebdf0823b3": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HBoxModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HBoxModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HBoxView",
            "box_style": "",
            "children": [
              "IPY_MODEL_37ea816011a743c894bb5e7c4ed005ee",
              "IPY_MODEL_53a416f4de6342c886d0ae038625f40f",
              "IPY_MODEL_6dbfc2e54f6a4a418029a726e9efc54e"
            ],
            "layout": "IPY_MODEL_d1e14ca42e974fdc82a013019156ec0e"
          }
        },
        "37ea816011a743c894bb5e7c4ed005ee": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HTMLModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HTMLModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HTMLView",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_66a17cca58f5415580a34286f26fa30e",
            "placeholder": "​",
            "style": "IPY_MODEL_dd7e1331fb1e4f2592a2a6b65fcaa313",
            "value": "ir-lab-wise-2024/subsampled-ms-marco-deep-learning-20241201-training documents: 100%"
          }
        },
        "53a416f4de6342c886d0ae038625f40f": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "FloatProgressModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "FloatProgressModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "ProgressView",
            "bar_style": "success",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_ca6d13fe4b2749429315b489bf40cf34",
            "max": 68261,
            "min": 0,
            "orientation": "horizontal",
            "style": "IPY_MODEL_8d1aa078ed1a4a91b8955d0e87bf1310",
            "value": 68261
          }
        },
        "6dbfc2e54f6a4a418029a726e9efc54e": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "HTMLModel",
          "model_module_version": "1.5.0",
          "state": {
            "_dom_classes": [],
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "HTMLModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/controls",
            "_view_module_version": "1.5.0",
            "_view_name": "HTMLView",
            "description": "",
            "description_tooltip": null,
            "layout": "IPY_MODEL_f09ed85d564542f7ac5d7ab6d42d1bf4",
            "placeholder": "​",
            "style": "IPY_MODEL_64d4f9d3a97b48b8a42b69faba9e2fe6",
            "value": " 68261/68261 [00:20&lt;00:00, 5097.77it/s]"
          }
        },
        "d1e14ca42e974fdc82a013019156ec0e": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "66a17cca58f5415580a34286f26fa30e": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "dd7e1331fb1e4f2592a2a6b65fcaa313": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "DescriptionStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "DescriptionStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "description_width": ""
          }
        },
        "ca6d13fe4b2749429315b489bf40cf34": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "8d1aa078ed1a4a91b8955d0e87bf1310": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "ProgressStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "ProgressStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "bar_color": null,
            "description_width": ""
          }
        },
        "f09ed85d564542f7ac5d7ab6d42d1bf4": {
          "model_module": "@jupyter-widgets/base",
          "model_name": "LayoutModel",
          "model_module_version": "1.2.0",
          "state": {
            "_model_module": "@jupyter-widgets/base",
            "_model_module_version": "1.2.0",
            "_model_name": "LayoutModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "LayoutView",
            "align_content": null,
            "align_items": null,
            "align_self": null,
            "border": null,
            "bottom": null,
            "display": null,
            "flex": null,
            "flex_flow": null,
            "grid_area": null,
            "grid_auto_columns": null,
            "grid_auto_flow": null,
            "grid_auto_rows": null,
            "grid_column": null,
            "grid_gap": null,
            "grid_row": null,
            "grid_template_areas": null,
            "grid_template_columns": null,
            "grid_template_rows": null,
            "height": null,
            "justify_content": null,
            "justify_items": null,
            "left": null,
            "margin": null,
            "max_height": null,
            "max_width": null,
            "min_height": null,
            "min_width": null,
            "object_fit": null,
            "object_position": null,
            "order": null,
            "overflow": null,
            "overflow_x": null,
            "overflow_y": null,
            "padding": null,
            "right": null,
            "top": null,
            "visibility": null,
            "width": null
          }
        },
        "64d4f9d3a97b48b8a42b69faba9e2fe6": {
          "model_module": "@jupyter-widgets/controls",
          "model_name": "DescriptionStyleModel",
          "model_module_version": "1.5.0",
          "state": {
            "_model_module": "@jupyter-widgets/controls",
            "_model_module_version": "1.5.0",
            "_model_name": "DescriptionStyleModel",
            "_view_count": null,
            "_view_module": "@jupyter-widgets/base",
            "_view_module_version": "1.2.0",
            "_view_name": "StyleView",
            "description_width": ""
          }
        }
      }
    },
    "accelerator": "GPU"
  },
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {
        "id": "view-in-github",
        "colab_type": "text"
      },
      "source": [
        "<a href=\"https://colab.research.google.com/github/len-rtz/wir-2024-relevancers/blob/main/relevancers_test_system_rewr_T5.ipbynb\" target=\"_parent\"><img src=\"https://colab.research.google.com/assets/colab-badge.svg\" alt=\"Open In Colab\"/></a>"
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "# Baseline System Team \"Relevancers\" TH Köln\n",
        "\n",
        "The following first draft retrieval systems builds onto the baseline system from https://github.com/irgroup-classrooms/wir-2024"
      ],
      "metadata": {
        "id": "2kB99G4rSTex"
      }
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "o2kmqUr1SGaH",
        "outputId": "38e02d11-3fb8-4313-ed0d-56c011037228"
      },
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "Requirement already satisfied: tira>=0.0.139 in /usr/local/lib/python3.11/dist-packages (0.0.143)\n",
            "Requirement already satisfied: ir-datasets in /usr/local/lib/python3.11/dist-packages (0.5.9)\n",
            "Requirement already satisfied: python-terrier==0.10.0 in /usr/local/lib/python3.11/dist-packages (0.10.0)\n",
            "Requirement already satisfied: numpy in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (1.26.4)\n",
            "Requirement already satisfied: pandas in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (2.2.2)\n",
            "Requirement already satisfied: wget in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (3.2)\n",
            "Requirement already satisfied: tqdm in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (4.67.1)\n",
            "Requirement already satisfied: pyjnius>=1.4.2 in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (1.6.1)\n",
            "Requirement already satisfied: matchpy in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (0.5.5)\n",
            "Requirement already satisfied: scikit-learn in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (1.6.0)\n",
            "Requirement already satisfied: deprecated in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (1.2.15)\n",
            "Requirement already satisfied: chest in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (0.2.3)\n",
            "Requirement already satisfied: scipy in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (1.13.1)\n",
            "Requirement already satisfied: requests in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (2.32.3)\n",
            "Requirement already satisfied: joblib in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (1.4.2)\n",
            "Requirement already satisfied: nptyping==1.4.4 in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (1.4.4)\n",
            "Requirement already satisfied: more-itertools in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (10.5.0)\n",
            "Requirement already satisfied: jinja2 in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (3.1.5)\n",
            "Requirement already satisfied: statsmodels in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (0.14.4)\n",
            "Requirement already satisfied: ir-measures>=0.3.1 in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (0.3.6)\n",
            "Requirement already satisfied: dill in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (0.3.9)\n",
            "Requirement already satisfied: pytrec-eval-terrier>=0.5.3 in /usr/local/lib/python3.11/dist-packages (from python-terrier==0.10.0) (0.5.6)\n",
            "Requirement already satisfied: typish>=1.7.0 in /usr/local/lib/python3.11/dist-packages (from nptyping==1.4.4->python-terrier==0.10.0) (1.9.3)\n",
            "Requirement already satisfied: docker==7.*,>=7.1.0 in /usr/local/lib/python3.11/dist-packages (from tira>=0.0.139) (7.1.0)\n",
            "Requirement already satisfied: packaging in /usr/local/lib/python3.11/dist-packages (from tira>=0.0.139) (24.2)\n",
            "Requirement already satisfied: urllib3>=1.26.0 in /usr/local/lib/python3.11/dist-packages (from docker==7.*,>=7.1.0->tira>=0.0.139) (2.3.0)\n",
            "Requirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.11/dist-packages (from requests->python-terrier==0.10.0) (3.4.1)\n",
            "Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.11/dist-packages (from requests->python-terrier==0.10.0) (3.10)\n",
            "Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.11/dist-packages (from requests->python-terrier==0.10.0) (2024.12.14)\n",
            "Requirement already satisfied: beautifulsoup4>=4.4.1 in /usr/local/lib/python3.11/dist-packages (from ir-datasets) (4.12.3)\n",
            "Requirement already satisfied: inscriptis>=2.2.0 in /usr/local/lib/python3.11/dist-packages (from ir-datasets) (2.5.3)\n",
            "Requirement already satisfied: lxml>=4.5.2 in /usr/local/lib/python3.11/dist-packages (from ir-datasets) (5.3.0)\n",
            "Requirement already satisfied: pyyaml>=5.3.1 in /usr/local/lib/python3.11/dist-packages (from ir-datasets) (6.0.2)\n",
            "Requirement already satisfied: trec-car-tools>=2.5.4 in /usr/local/lib/python3.11/dist-packages (from ir-datasets) (2.6)\n",
            "Requirement already satisfied: lz4>=3.1.10 in /usr/local/lib/python3.11/dist-packages (from ir-datasets) (4.3.3)\n",
            "Requirement already satisfied: warc3-wet>=0.2.3 in /usr/local/lib/python3.11/dist-packages (from ir-datasets) (0.2.5)\n",
            "Requirement already satisfied: warc3-wet-clueweb09>=0.2.5 in /usr/local/lib/python3.11/dist-packages (from ir-datasets) (0.2.5)\n",
            "Requirement already satisfied: zlib-state>=0.1.3 in /usr/local/lib/python3.11/dist-packages (from ir-datasets) (0.1.9)\n",
            "Requirement already satisfied: ijson>=3.1.3 in /usr/local/lib/python3.11/dist-packages (from ir-datasets) (3.3.0)\n",
            "Requirement already satisfied: unlzw3>=0.2.1 in /usr/local/lib/python3.11/dist-packages (from ir-datasets) (0.2.3)\n",
            "Requirement already satisfied: soupsieve>1.2 in /usr/local/lib/python3.11/dist-packages (from beautifulsoup4>=4.4.1->ir-datasets) (2.6)\n",
            "Requirement already satisfied: cbor>=1.0.0 in /usr/local/lib/python3.11/dist-packages (from trec-car-tools>=2.5.4->ir-datasets) (1.0.0)\n",
            "Requirement already satisfied: heapdict in /usr/local/lib/python3.11/dist-packages (from chest->python-terrier==0.10.0) (1.0.1)\n",
            "Requirement already satisfied: wrapt<2,>=1.10 in /usr/local/lib/python3.11/dist-packages (from deprecated->python-terrier==0.10.0) (1.17.0)\n",
            "Requirement already satisfied: MarkupSafe>=2.0 in /usr/local/lib/python3.11/dist-packages (from jinja2->python-terrier==0.10.0) (3.0.2)\n",
            "Requirement already satisfied: multiset<3.0,>=2.0 in /usr/local/lib/python3.11/dist-packages (from matchpy->python-terrier==0.10.0) (2.1.1)\n",
            "Requirement already satisfied: python-dateutil>=2.8.2 in /usr/local/lib/python3.11/dist-packages (from pandas->python-terrier==0.10.0) (2.8.2)\n",
            "Requirement already satisfied: pytz>=2020.1 in /usr/local/lib/python3.11/dist-packages (from pandas->python-terrier==0.10.0) (2024.2)\n",
            "Requirement already satisfied: tzdata>=2022.7 in /usr/local/lib/python3.11/dist-packages (from pandas->python-terrier==0.10.0) (2024.2)\n",
            "Requirement already satisfied: threadpoolctl>=3.1.0 in /usr/local/lib/python3.11/dist-packages (from scikit-learn->python-terrier==0.10.0) (3.5.0)\n",
            "Requirement already satisfied: patsy>=0.5.6 in /usr/local/lib/python3.11/dist-packages (from statsmodels->python-terrier==0.10.0) (1.0.1)\n",
            "Requirement already satisfied: six>=1.5 in /usr/local/lib/python3.11/dist-packages (from python-dateutil>=2.8.2->pandas->python-terrier==0.10.0) (1.17.0)\n",
            "Requirement already satisfied: transformers in /usr/local/lib/python3.11/dist-packages (4.47.1)\n",
            "Requirement already satisfied: filelock in /usr/local/lib/python3.11/dist-packages (from transformers) (3.16.1)\n",
            "Requirement already satisfied: huggingface-hub<1.0,>=0.24.0 in /usr/local/lib/python3.11/dist-packages (from transformers) (0.27.1)\n",
            "Requirement already satisfied: numpy>=1.17 in /usr/local/lib/python3.11/dist-packages (from transformers) (1.26.4)\n",
            "Requirement already satisfied: packaging>=20.0 in /usr/local/lib/python3.11/dist-packages (from transformers) (24.2)\n",
            "Requirement already satisfied: pyyaml>=5.1 in /usr/local/lib/python3.11/dist-packages (from transformers) (6.0.2)\n",
            "Requirement already satisfied: regex!=2019.12.17 in /usr/local/lib/python3.11/dist-packages (from transformers) (2024.11.6)\n",
            "Requirement already satisfied: requests in /usr/local/lib/python3.11/dist-packages (from transformers) (2.32.3)\n",
            "Requirement already satisfied: tokenizers<0.22,>=0.21 in /usr/local/lib/python3.11/dist-packages (from transformers) (0.21.0)\n",
            "Requirement already satisfied: safetensors>=0.4.1 in /usr/local/lib/python3.11/dist-packages (from transformers) (0.5.2)\n",
            "Requirement already satisfied: tqdm>=4.27 in /usr/local/lib/python3.11/dist-packages (from transformers) (4.67.1)\n",
            "Requirement already satisfied: fsspec>=2023.5.0 in /usr/local/lib/python3.11/dist-packages (from huggingface-hub<1.0,>=0.24.0->transformers) (2024.10.0)\n",
            "Requirement already satisfied: typing-extensions>=3.7.4.3 in /usr/local/lib/python3.11/dist-packages (from huggingface-hub<1.0,>=0.24.0->transformers) (4.12.2)\n",
            "Requirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.11/dist-packages (from requests->transformers) (3.4.1)\n",
            "Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.11/dist-packages (from requests->transformers) (3.10)\n",
            "Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/lib/python3.11/dist-packages (from requests->transformers) (2.3.0)\n",
            "Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.11/dist-packages (from requests->transformers) (2024.12.14)\n"
          ]
        }
      ],
      "source": [
        "# Install required libraries\n",
        "!pip3 install 'tira>=0.0.139' ir-datasets 'python-terrier==0.10.0'\n",
        "!pip install transformers\n",
        "\n",
        "# Import necessary libraries\n",
        "import pyterrier as pt\n",
        "import pandas as pd\n",
        "from nltk.corpus import stopwords\n",
        "import re\n",
        "import nltk\n",
        "from transformers import pipeline\n",
        "from pyterrier import IterDictIndexer"
      ]
    },
    {
      "cell_type": "code",
      "source": [
        "# Create an API client to interact with the TIRA platform\n",
        "from tira.third_party_integrations import ensure_pyterrier_is_loaded\n",
        "from tira.rest_api_client import Client\n",
        "\n",
        "ensure_pyterrier_is_loaded()\n",
        "tira = Client()"
      ],
      "metadata": {
        "id": "bV_rITFTS2z0"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "# Load Dataset\n",
        "from pyterrier import get_dataset\n",
        "\n",
        "pt_dataset = get_dataset('irds:ir-lab-wise-2024/subsampled-ms-marco-deep-learning-20241201-training')"
      ],
      "metadata": {
        "id": "xrp7UYefTEi_"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "source": [
        "# Data Cleaning & Preprocessing"
      ],
      "metadata": {
        "id": "euoPOF3bWBox"
      }
    },
    {
      "cell_type": "code",
      "source": [
        "# Download stopwords\n",
        "nltk.download('stopwords')\n",
        "stop_words = set(stopwords.words('english'))\n",
        "\n",
        "# Text preprocessing\n",
        "def clean_text(text):\n",
        "    text = text.lower()\n",
        "    text = re.sub(r'[^\\w\\s]', ' ', text)\n",
        "    text = ' '.join([word for word in text.split() if word not in stop_words])\n",
        "    return text"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "lC9Gg5MGWE1l",
        "outputId": "2482f23b-3d0c-44ee-8303-b62e7cea668d"
      },
      "execution_count": null,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stderr",
          "text": [
            "[nltk_data] Downloading package stopwords to /root/nltk_data...\n",
            "[nltk_data]   Unzipping corpora/stopwords.zip.\n"
          ]
        }
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "# Create Index"
      ],
      "metadata": {
        "id": "CbO_G7E0XZz7"
      }
    },
    {
      "cell_type": "code",
      "source": [
        "# Create indexer\n",
        "indexer = IterDictIndexer(\n",
        "    \"../data/clean_index\",\n",
        "    meta={'docno': 50, 'text': 4096},\n",
        "    overwrite=True\n",
        ")\n",
        "\n",
        "# Create clean document iterator\n",
        "def clean_docs_iter():\n",
        "    for doc in pt_dataset.get_corpus_iter():\n",
        "        yield {'docno': doc['docno'], 'text': clean_text(doc['text'])}\n",
        "\n",
        "# Build index\n",
        "index = indexer.index(clean_docs_iter())"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/",
          "height": 173,
          "referenced_widgets": [
            "39f425f303a64b2cadcc53ebdf0823b3",
            "37ea816011a743c894bb5e7c4ed005ee",
            "53a416f4de6342c886d0ae038625f40f",
            "6dbfc2e54f6a4a418029a726e9efc54e",
            "d1e14ca42e974fdc82a013019156ec0e",
            "66a17cca58f5415580a34286f26fa30e",
            "dd7e1331fb1e4f2592a2a6b65fcaa313",
            "ca6d13fe4b2749429315b489bf40cf34",
            "8d1aa078ed1a4a91b8955d0e87bf1310",
            "f09ed85d564542f7ac5d7ab6d42d1bf4",
            "64d4f9d3a97b48b8a42b69faba9e2fe6"
          ]
        },
        "id": "lV3aHZlrXLnm",
        "outputId": "0ba7716c-479b-4d4c-b14a-3dee04439985"
      },
      "execution_count": null,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "Download from Zenodo: https://zenodo.org/records/14254044/files/subsampled-ms-marco-deep-learning-20241201-training-inputs.zip\n"
          ]
        },
        {
          "output_type": "stream",
          "name": "stderr",
          "text": [
            "Download: 100%|██████████| 9.51M/9.51M [00:01<00:00, 6.14MiB/s]\n"
          ]
        },
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "Download finished. Extract...\n",
            "Extraction finished:  /root/.tira/extracted_datasets/ir-lab-wise-2024/subsampled-ms-marco-deep-learning-20241201-training/\n"
          ]
        },
        {
          "output_type": "display_data",
          "data": {
            "text/plain": [
              "ir-lab-wise-2024/subsampled-ms-marco-deep-learning-20241201-training documents:   0%|          | 0/68261 [00:0…"
            ],
            "application/vnd.jupyter.widget-view+json": {
              "version_major": 2,
              "version_minor": 0,
              "model_id": "39f425f303a64b2cadcc53ebdf0823b3"
            }
          },
          "metadata": {}
        },
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "15:58:29.427 [ForkJoinPool-1-worker-3] WARN org.terrier.structures.indexing.Indexer - Adding an empty document to the index (6114613) - further warnings are suppressed\n",
            "15:58:40.643 [ForkJoinPool-1-worker-3] WARN org.terrier.structures.indexing.Indexer - Indexed 1 empty documents\n"
          ]
        }
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "# Query Rewriting"
      ],
      "metadata": {
        "id": "W1ak5DCOzvgK"
      }
    },
    {
      "cell_type": "code",
      "source": [
        "class T5QueryRewriter(pt.Transformer):\n",
        "    def __init__(self, num_beams=5, temperature=0.7, num_reformulations=3):\n",
        "        super().__init__()\n",
        "        self.num_beams = num_beams\n",
        "        self.temperature = temperature\n",
        "        self.num_reformulations = num_reformulations\n",
        "\n",
        "        # Initialize model and tokenizer\n",
        "        self.tokenizer = AutoTokenizer.from_pretrained(\"prhegde/t5-query-reformulation-RL\")\n",
        "        self.model = AutoModelForSeq2SeqLM.from_pretrained(\"prhegde/t5-query-reformulation-RL\")\n",
        "\n",
        "        # Move to GPU if available\n",
        "        self.device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')\n",
        "        self.model = self.model.to(self.device)\n",
        "\n",
        "    def clean_query(self, query):\n",
        "        \"\"\"\n",
        "        Clean query for PyTerrier compatibility.\n",
        "        \"\"\"\n",
        "        # Convert to string if not already\n",
        "        query = str(query)\n",
        "\n",
        "        # Remove special characters but keep basic punctuation\n",
        "        query = re.sub(r'[^a-zA-Z0-9\\s.,?!-]', '', query)\n",
        "\n",
        "        # Replace multiple spaces with single space\n",
        "        query = re.sub(r'\\s+', ' ', query)\n",
        "\n",
        "        # Remove trailing punctuation\n",
        "        query = re.sub(r'[.,?!-]+$', '', query)\n",
        "\n",
        "        # Trim whitespace\n",
        "        query = query.strip()\n",
        "\n",
        "        return query\n",
        "\n",
        "    def reformulate_query(self, query):\n",
        "        \"\"\"\n",
        "        Reformulate a single query using the T5 model.\n",
        "        \"\"\"\n",
        "        # Ensure query is a string and clean it\n",
        "        text = self.clean_query(str(query))\n",
        "\n",
        "        # Skip empty queries\n",
        "        if not text:\n",
        "            return [query] * self.num_reformulations\n",
        "\n",
        "        # Encode text\n",
        "        encoding = self.tokenizer.encode_plus(\n",
        "            text,\n",
        "            max_length=128,\n",
        "            padding='longest',\n",
        "            truncation=True,\n",
        "            return_tensors=\"pt\"\n",
        "        )\n",
        "\n",
        "        # Move tensors to device\n",
        "        input_ids = encoding['input_ids'].to(self.device)\n",
        "        attention_mask = encoding['attention_mask'].to(self.device)\n",
        "\n",
        "        # Set random seed for reproducibility\n",
        "        torch.manual_seed(42)\n",
        "\n",
        "        try:\n",
        "            # Generate reformulated outputs\n",
        "            with torch.no_grad():\n",
        "                outputs = self.model.generate(\n",
        "                    input_ids=input_ids,\n",
        "                    attention_mask=attention_mask,\n",
        "                    max_length=128,\n",
        "                    min_length=5,\n",
        "                    num_beams=self.num_beams,\n",
        "                    num_return_sequences=self.num_reformulations,\n",
        "                    temperature=self.temperature,\n",
        "                    do_sample=True,\n",
        "                    top_k=50,\n",
        "                    top_p=0.95,\n",
        "                    early_stopping=True,\n",
        "                    repetition_penalty=1.5,\n",
        "                    length_penalty=1.0,\n",
        "                    no_repeat_ngram_size=2\n",
        "                )\n",
        "\n",
        "            # Decode and clean outputs\n",
        "            reformulations = [\n",
        "                self.clean_query(self.tokenizer.decode(output, skip_special_tokens=True))\n",
        "                for output in outputs\n",
        "            ]\n",
        "\n",
        "            # Filter out empty reformulations\n",
        "            reformulations = [r for r in reformulations if r]\n",
        "\n",
        "            # If all reformulations were filtered out, return original query\n",
        "            if not reformulations:\n",
        "                return [text] * self.num_reformulations\n",
        "\n",
        "            # Pad with original query if we don't have enough reformulations\n",
        "            while len(reformulations) < self.num_reformulations:\n",
        "                reformulations.append(text)\n",
        "\n",
        "            return reformulations\n",
        "\n",
        "        except Exception as e:\n",
        "            print(f\"Error reformulating query '{text}': {str(e)}\")\n",
        "            return [text] * self.num_reformulations\n",
        "\n",
        "    def transform(self, topics):\n",
        "        \"\"\"\n",
        "        Transform topics by reformulating queries.\n",
        "        \"\"\"\n",
        "        # Create a copy of the input topics\n",
        "        new_topics = topics.copy()\n",
        "\n",
        "        # Determine which column contains the query\n",
        "        query_column = 'text' if 'text' in new_topics.columns else 'query'\n",
        "\n",
        "        # Add column for all reformulations\n",
        "        new_topics['all_reformulations'] = new_topics[query_column].apply(self.reformulate_query)\n",
        "\n",
        "        # Use first reformulation as the main query for compatibility\n",
        "        new_topics[query_column] = new_topics['all_reformulations'].apply(lambda x: x[0])\n",
        "\n",
        "        return new_topics"
      ],
      "metadata": {
        "id": "HLWZCaLrzykY"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "def print_example_reformulations(topics, reformulator):\n",
        "    \"\"\"Print example query reformulations.\"\"\"\n",
        "    print(\"Example Query Reformulations:\")\n",
        "    sample_topics = topics.head(3)\n",
        "\n",
        "    transformed = reformulator.transform(sample_topics)\n",
        "    for _, row in transformed.iterrows():\n",
        "        query_col = 'text' if 'text' in row else 'query'\n",
        "        original = row[query_col]\n",
        "        reformulations = row['all_reformulations']\n",
        "\n",
        "        print(f\"\\nOriginal: {original}\")\n",
        "        print(\"Reformulated versions:\")\n",
        "        for i, reform in enumerate(reformulations, 1):\n",
        "            print(f\"{i}. {reform}\")\n",
        "        print(\"-\" * 50)"
      ],
      "metadata": {
        "id": "Row1pu5B7OPl"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "source": [
        "# Usage example:\n",
        "if __name__ == \"__main__\":\n",
        "    # Create reformulator\n",
        "    reformulator = T5QueryRewriter(\n",
        "        num_beams=5,\n",
        "        temperature=0.7,\n",
        "        num_reformulations=3\n",
        "    )\n",
        "\n",
        "    # Test with a single query\n",
        "    test_query = \"how does climate change affect wildlife?\"\n",
        "    reformulations = reformulator.reformulate_query(test_query)\n",
        "\n",
        "    print(f\"Original Query: {test_query}\")\n",
        "    print(\"\\nReformulated versions:\")\n",
        "    for i, reform in enumerate(reformulations, 1):\n",
        "        print(f\"{i}. {reform}\")"
      ],
      "metadata": {
        "id": "rpEEpDUYzuWl",
        "outputId": "bc50ed11-69da-4068-e569-f1a18186c4d6",
        "colab": {
          "base_uri": "https://localhost:8080/"
        }
      },
      "execution_count": null,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "Original Query: how does climate change affect wildlife?\n",
            "\n",
            "Reformulated versions:\n",
            "1. how does climate change affect wildlife\n",
            "2. how does climate change affect wildlife\n",
            "3. impacts of climate change on wildlife\n"
          ]
        }
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "# Retrieve Topics"
      ],
      "metadata": {
        "id": "8PBqKoJRL9Rh"
      }
    },
    {
      "cell_type": "code",
      "source": [
        "# Retrieve topics\n",
        "topics = pt_dataset.get_topics('text')"
      ],
      "metadata": {
        "id": "pVamrs_iL89g"
      },
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "source": [
        "# Retrieval"
      ],
      "metadata": {
        "id": "hGJ94cPKXRdj"
      }
    },
    {
      "cell_type": "code",
      "source": [
        "# Define retrieval models\n",
        "bm25 = pt.BatchRetrieve(index, wmodel=\"BM25\")\n",
        "bm25_rm3 = bm25 >> pt.rewrite.RM3(index) >> bm25\n",
        "\n",
        "# Create T5 rewriter pipeline with multiple reformulations\n",
        "reformulator = T5QueryRewriter(num_beams=5, temperature=0.7, num_reformulations=3)\n",
        "\n",
        "# Print some example reformulations first\n",
        "print_example_reformulations(topics, reformulator)\n",
        "\n",
        "# Create the combined pipelines\n",
        "bm25_reformulated = reformulator >> bm25\n",
        "bm25_reformulated_rm3 = reformulator >> bm25_rm3\n",
        "\n",
        "# Evaluate all models\n",
        "results = pt.Experiment(\n",
        "    [bm25_rm3, bm25_reformulated, bm25_reformulated_rm3],\n",
        "    topics,\n",
        "    pt_dataset.get_qrels(),\n",
        "    eval_metrics=[\"map\", \"recip_rank\", \"ndcg_cut_10\", \"P_1\", \"P_5\", \"P_10\"],\n",
        "    names=[\"BM25+RM3\", \"BM25+Reform\", \"BM25+Reform+RM3\"]\n",
        ")\n",
        "print(\"\\nEvaluation Results:\")\n",
        "print(results)"
      ],
      "metadata": {
        "colab": {
          "base_uri": "https://localhost:8080/"
        },
        "id": "x3mrfNf6XMhR",
        "outputId": "379a826b-35c1-4ea7-bc01-9a23667ae05a"
      },
      "execution_count": null,
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": [
            "Example Query Reformulations:\n",
            "\n",
            "Original: aziz hashim is known as the leader of the israeli revolution\n",
            "Reformulated versions:\n",
            "1. aziz hashim is known as the leader of the israeli revolution\n",
            "2. aziz hashim is known as the leader of israel\n",
            "3. aziz hashim is known as the leader of the islamist movement\n",
            "--------------------------------------------------\n",
            "\n",
            "Original: who is rep. scalise\n",
            "Reformulated versions:\n",
            "1. who is rep. scalise\n",
            "2. who is rep scalise\n",
            "3. who is rep. scalise\n",
            "--------------------------------------------------\n",
            "\n",
            "Original: who killed nicholas ii of russia\n",
            "Reformulated versions:\n",
            "1. who killed nicholas ii of russia\n",
            "2. who killed nicholas ii of russia\n",
            "3. who shot nicholas ii\n",
            "--------------------------------------------------\n",
            "\n",
            "Evaluation Results:\n",
            "              name       map  recip_rank  ndcg_cut_10       P_1       P_5  \\\n",
            "0         BM25+RM3  0.452199    0.768722     0.512417  0.680412  0.653608   \n",
            "1      BM25+Reform  0.382817    0.697691     0.426565  0.587629  0.534021   \n",
            "2  BM25+Reform+RM3  0.421044    0.696987     0.449395  0.608247  0.583505   \n",
            "\n",
            "       P_10  \n",
            "0  0.612371  \n",
            "1  0.508247  \n",
            "2  0.545361  \n"
          ]
        }
      ]
    },
    {
      "cell_type": "markdown",
      "source": [
        "# Upload to TIRA"
      ],
      "metadata": {
        "id": "Xw_gOqcgaCBj"
      }
    },
    {
      "cell_type": "code",
      "source": [
        "import os\n",
        "from tira.third_party_integrations import persist_and_normalize_run\n",
        "\n",
        "# Define the directory path for saving runs\n",
        "run_dir = '../data/runs'\n",
        "\n",
        "# Create the directory if it does not exist\n",
        "os.makedirs(run_dir, exist_ok=True)\n",
        "\n",
        "# Assign the results to the 'run' variable\n",
        "run = bm25_reformulated(pt_dataset.get_topics('text'))\n",
        "\n",
        "# Persist and normalize the run\n",
        "persist_and_normalize_run(\n",
        "    run,\n",
        "    system_name='bm25+reform_t5-relevancers',\n",
        "    default_output=run_dir,\n",
        "    upload_to_tira=pt_dataset,\n",
        ")"
      ],
      "metadata": {
        "id": "DwE303l4QNAv"
      },
      "execution_count": null,
      "outputs": []
    }
  ]
}